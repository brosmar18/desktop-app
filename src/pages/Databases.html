<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';">
    <title>PostgreSQL Explorer - Databases</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/home.css">
    <link rel="stylesheet" href="../styles/databases.css">
    <link rel="stylesheet" href="../styles/menu.css">
    <link rel="stylesheet" href="../styles/modal.css">
</head>

<body class="dark-mode">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h2 class="sidebar-title">AppDev Workstation</h2>
            <nav class="sidebar-nav">
                <a href="../pages/Home.html" class="sidebar-link">Dashboard</a>
                <a href="../pages/Databases.html" class="sidebar-link active">Databases</a>
                <a href="../pages/Restore.html" class="sidebar-link">Restore</a>
                <a href="#" class="sidebar-link">Queries</a>
                <a href="#" class="sidebar-link">Settings</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <h1 class="header-title">Databases</h1>
                <div class="header-actions">
                    <div class="theme-toggle-container">
                        <button id="theme-toggle-btn" class="theme-toggle-btn">☀️</button>
                    </div>
                    <div class="logout-container">
                        <button id="logout-btn" class="logout-button">Logout</button>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <main class="content">
                <!-- Database Explorer Layout -->
                <div class="explorer-container">
                    <!-- Database List Panel -->
                    <div class="explorer-sidebar">
                        <div class="explorer-search">
                            <input type="text" id="database-search" placeholder="Search databases..."
                                class="search-input">
                        </div>
                        <div class="explorer-list">
                            <div class="explorer-header">
                                <h3 class="explorer-title">Databases</h3>
                                <button id="refresh-databases-btn" class="refresh-button" title="Refresh Databases">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z" />
                                        <path
                                            d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z" />
                                    </svg>
                                </button>
                            </div>
                            <ul id="database-list" class="item-list">
                                <li class="list-item loading">Loading databases...</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Tables and Columns Panel -->
                    <div class="explorer-content">
                        <!-- No Database Selected State -->
                        <div id="no-selection" class="empty-state">
                            <p>Select a database to view its tables</p>
                        </div>

                        <!-- Selected Database Tables - Improved Layout -->
                        <div id="tables-view" class="tables-container" style="display: none;">
                            <div class="tables-header">
                                <h3 class="content-title">Tables in <span id="selected-db-name">database</span></h3>

                                <div class="tables-meta">
                                    <span id="tables-count" class="tables-count">0 tables</span>
                                    <div class="tables-actions">
                                        <div class="view-toggle">
                                            <button id="grid-view-btn" class="view-btn" title="Grid View">
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                                    <path
                                                        d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zm8 0A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm-8 8A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm8 0A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3a1.5 1.5 0 0 1-1.5-1.5v-3z" />
                                                </svg>
                                            </button>
                                            <button id="list-view-btn" class="view-btn active" title="List View">
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                                    <path fill-rule="evenodd"
                                                        d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h12a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5H2zM2 6.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h12a.5.5 0 0 0 .5-.5V7a.5.5 0 0 0-.5-.5H2zM2 10.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h12a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5H2z" />
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="sort-container">
                                            <label for="sort-tables">Sort:</label>
                                            <select id="sort-tables" class="sort-select">
                                                <option value="name-asc">Name (A-Z)</option>
                                                <option value="name-desc">Name (Z-A)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-bar">
                                <input type="text" id="table-filter" class="filter-input"
                                    placeholder="Filter tables...">
                                <button id="clear-filter" class="clear-filter-btn" title="Clear filter">✕</button>
                            </div>

                            <!-- Grid View (default) -->
                            <div id="grid-view" class="tables-grid" style="display: none;">
                                <!-- Tables will be populated here as grid items -->
                            </div>

                            <!-- List View (alternative) -->
                            <div id="list-view" class="tables-list-view">
                                <table class="tables-table">
                                    <thead>
                                        <tr>
                                            <th class="th-name">Name</th>
                                            <th class="th-type">Type</th>
                                            <th class="th-actions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tables-list-body">
                                        <!-- Tables will be populated here as rows -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Empty State -->
                            <div id="tables-empty" class="tables-empty" style="display: none;">
                                <div class="empty-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="3" y1="9" x2="21" y2="9"></line>
                                        <line x1="9" y1="21" x2="9" y2="9"></line>
                                    </svg>
                                </div>
                                <p class="empty-message">No tables found in this database</p>
                            </div>
                        </div>

                        <!-- Selected Table Columns - Improved Layout -->
                        <div id="columns-view" class="columns-container" style="display: none;">
                            <div class="columns-header">
                                <div class="breadcrumb">
                                    <a href="#" id="back-to-tables" class="breadcrumb-link">
                                        <span id="db-breadcrumb">database</span>
                                    </a>
                                    <span class="breadcrumb-separator">›</span>
                                    <span id="table-breadcrumb" class="breadcrumb-current">table</span>
                                </div>

                                <h3 class="content-title">Columns in <span id="selected-table-name">table</span></h3>

                                <div class="columns-actions">
                                    <div class="filter-bar">
                                        <input type="text" id="column-filter" class="filter-input"
                                            placeholder="Filter columns...">
                                        <button id="clear-column-filter" class="clear-filter-btn"
                                            title="Clear filter">✕</button>
                                    </div>

                                    <div class="sort-container">
                                        <label for="sort-columns">Sort:</label>
                                        <select id="sort-columns" class="sort-select">
                                            <option value="name-asc">Name (A-Z)</option>
                                            <option value="name-desc">Name (Z-A)</option>
                                            <option value="type">Type</option>
                                            <option value="position">Position (Default)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="columns-table-container">
                                <table class="columns-table">
                                    <thead>
                                        <tr>
                                            <th class="th-name">Name</th>
                                            <th class="th-type">Type</th>
                                            <th class="th-nullable">Nullable</th>
                                            <th class="th-default">Default Value</th>
                                        </tr>
                                    </thead>
                                    <tbody id="columns-list">
                                        <!-- Columns will be populated here -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="empty-columns" id="empty-columns" style="display: none;">
                                <div class="empty-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="1">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="3" y1="9" x2="21" y2="9"></line>
                                        <line x1="3" y1="15" x2="21" y2="15"></line>
                                        <line x1="9" y1="9" x2="9" y2="21"></line>
                                        <line x1="15" y1="9" x2="15" y2="21"></line>
                                    </svg>
                                </div>
                                <p class="empty-message">No columns found in this table</p>
                            </div>

                            <div class="back-button-container">
                                <button id="back-to-tables-btn" class="back-button">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z" />
                                    </svg>
                                    Back to Tables
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Include utility scripts first -->
    <script src="../utils/theme.js"></script>
    <script src="../utils/database-api.js"></script>
    <script src="../utils/ui-utils.js"></script>

    <!-- Initialize database operations directly -->

    <!-- Create global database operations object immediately -->
    <script>
        (function () {
            console.log('Creating global dbOperations object directly');

            // Create global object first
            window.dbOperations = {};

            // Then add the methods to avoid redeclaration issues
            window.dbOperations.cloneDatabase = async function (sourceDb, targetDb, includeData) {
                console.log(`Direct cloneDatabase called with:`, sourceDb, targetDb, includeData);

                try {
                    // Call the API to clone the database
                    const result = await window.api.cloneDatabase({
                        sourceDb,
                        targetDb,
                        withData: includeData
                    });

                    console.log('Clone result from API:', result);

                    return {
                        success: result?.success || false,
                        message: result?.success ? `Successfully cloned ${sourceDb} to ${targetDb}` : null,
                        error: result?.error || null
                    };
                } catch (error) {
                    console.error('Error in cloneDatabase:', error);
                    return {
                        success: false,
                        error: error.message || 'Failed to clone database'
                    };
                }
            };

            // Add other operations as needed
            window.dbOperations.backupDatabase = async function () {
                return { success: true };
            };
            window.dbOperations.renameDatabase = async function () {
                return { success: true };
            };
            window.dbOperations.deleteDatabase = async function () {
                return { success: true };
            };
            window.dbOperations.executeQuery = async function (dbName, query) {
                console.log(`Executing query on database ${dbName}`);

                try {
                    // Call the API to execute the query
                    if (window.api && window.api.executeQuery) {
                        try {
                            console.log('Using IPC API for query execution');
                            const result = await window.api.executeQuery(dbName, query);
                            console.log('Query result received:', result);

                            if (result.success) {
                                // For SELECT queries
                                if (result.command === 'SELECT') {
                                    return {
                                        success: true,
                                        message: `Query executed successfully: ${result.rowCount} rows returned`,
                                        columns: result.columns,
                                        rows: result.rows
                                    };
                                }
                                // For non-SELECT queries
                                else {
                                    return {
                                        success: true,
                                        message: result.message,
                                        // Add columns and a single row for display
                                        columns: ['message'],
                                        rows: [{ message: result.message }]
                                    };
                                }
                            } else {
                                console.error('Query failed:', result.error);
                                return {
                                    success: false,
                                    error: result.error || 'Failed to execute query'
                                };
                            }
                        } catch (apiError) {
                            console.error('IPC API failed:', apiError);
                            // Fall back to mock implementation if IPC fails
                            return fallbackQueryExecution(dbName, query);
                        }
                    } else {
                        console.log('API not available, using fallback implementation');
                        return fallbackQueryExecution(dbName, query);
                    }
                } catch (error) {
                    console.error('Error executing query:', error);
                    return {
                        success: false,
                        error: error.message || 'Failed to execute query'
                    };
                }
            };

            // Fallback implementation for testing
            function fallbackQueryExecution(dbName, query) {
                console.log('Using mock implementation for query execution');
                return new Promise(resolve => {
                    setTimeout(() => {
                        // Parse the query to determine response type
                        if (query.toLowerCase().includes('select') && query.toLowerCase().includes('from')) {
                            // Extract table name
                            const tableMatch = query.match(/from\s+["']?(\w+)["']?/i);
                            const tableName = tableMatch ? tableMatch[1] : 'unknown_table';

                            // Mock columns based on common tables
                            let columns = [];
                            let rows = [];

                            if (tableName.toLowerCase() === 'employee' || tableName.toLowerCase() === 'employees') {
                                columns = ['id', 'name', 'department', 'salary', 'hire_date'];
                                rows = [
                                    { id: 1, name: 'John Doe', department: 'Engineering', salary: 75000, hire_date: '2020-01-15' },
                                    { id: 2, name: 'Jane Smith', department: 'Marketing', salary: 65000, hire_date: '2021-03-10' },
                                    { id: 3, name: 'Bob Johnson', department: 'Finance', salary: 80000, hire_date: '2019-11-05' },
                                ];
                            } else if (tableName.toLowerCase() === 'accidnt' || tableName.toLowerCase().includes('accident')) {
                                columns = ['id', 'date', 'location', 'severity', 'description'];
                                rows = [
                                    { id: 1, date: '2023-06-12', location: 'Main St', severity: 'Minor', description: 'Fender bender' },
                                    { id: 2, date: '2023-07-22', location: 'Oak Ave', severity: 'Moderate', description: 'Side collision' },
                                    { id: 3, date: '2023-08-05', location: 'Pine Rd', severity: 'Major', description: 'Multi-car pileup' },
                                ];
                            } else if (query.toLowerCase().includes('pg_tables') || tableName.toLowerCase() === 'pg_tables') {
                                columns = ['schemaname', 'tablename', 'tableowner', 'hasindexes'];
                                rows = [
                                    { schemaname: 'public', tablename: 'employee', tableowner: 'postgres', hasindexes: true },
                                    { schemaname: 'public', tablename: 'department', tableowner: 'postgres', hasindexes: true },
                                    { schemaname: 'public', tablename: 'accidnt', tableowner: 'postgres', hasindexes: true },
                                ];
                            } else {
                                columns = ['column1', 'column2', 'column3'];
                                rows = [
                                    { column1: 'Value 1-1', column2: 'Value 1-2', column3: 'Value 1-3' },
                                    { column1: 'Value 2-1', column2: 'Value 2-2', column3: 'Value 2-3' },
                                ];
                            }

                            resolve({
                                success: true,
                                message: `Query executed successfully: ${rows.length} rows returned`,
                                columns: columns,
                                rows: rows
                            });
                        } else {
                            // For non-SELECT queries
                            resolve({
                                success: true,
                                message: 'Query executed successfully',
                                columns: ['message'],
                                rows: [{ message: 'Query executed successfully (mock)' }]
                            });
                        }
                    }, 1000); // 1 second delay to simulate execution time
                });
            }
            console.log('Global dbOperations object created:', !!window.dbOperations);
            console.log('Clone function available:', !!window.dbOperations.cloneDatabase);
        })();
    </script>
    <!-- Include page-specific script -->
    <script src="../js/databases-es5.js"></script>
</body>

</html>